<!DOCTYPE html>
<html lang="en">
  <head>
    <%- include("./partials/meta") %>
    <title>Manga Store - Orders</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" />
    <link rel="stylesheet" href="/css/build.min.css" />
  </head>
  <body
    class="bg-background-light dark:bg-background-dark text-text-light dark:text-text-dark min-h-screen flex flex-col">
    <%- include("./partials/header") %> <%- include("./partials/alerts-popups") %> <%- include("./partials/loader") %>

    <main class="flex-grow container mx-auto px-4 py-8">
      <h1 class="text-3xl font-bold mb-8 text-center text-primary-light dark:text-primary-dark">My Orders</h1>

      <div class="bg-white dark:bg-secondary-dark rounded-lg shadow-md p-6 mb-8">
        <div class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4">
          <% if (user.photoURL) { %>
            <% const isExternal = /^https?:\/\//.test(user.photoURL || ''); %>
            <% const avatarSrc = isExternal ? ('/avatar?url=' + encodeURIComponent(user.photoURL)) : user.photoURL; %>
            <img
              src="<%= avatarSrc %>"
              alt="<%= user.name || 'User' %>"
              class="w-24 h-24 rounded-full object-cover border-2 border-primary-light dark:border-primary-dark" />
          <% } else { %>
            <% const initial = (user.name || '').trim().charAt(0).toUpperCase() || '?' %>
            <div
              class="w-24 h-24 rounded-full flex items-center justify-center text-3xl font-bold bg-primary-light text-white dark:bg-primary-dark border-2 border-primary-light dark:border-primary-dark">
              <%= initial %>
            </div>
          <% } %>
          <div>
            <h2 class="text-xl font-semibold"><%= user.name %></h2>
            <p class="text-gray-600 dark:text-gray-400"><%= user.email %></p>
            <p class="text-sm text-gray-500 dark:text-gray-400">
              Member since <%= new Date(user.createdAt.toDate()).toLocaleString('en-US', { month: 'long', year:
              'numeric' }) %>
            </p>
          </div>
          <!-- <button
            id="logout"
            class="ml-auto bg-accent-light dark:bg-accent-dark text-white px-4 py-2 rounded-md hover:bg-opacity-90 transition-colors duration-200">
            <i class="fa-solid fa-right-from-bracket mr-2"></i>Logout
          </button> -->
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-white dark:bg-secondary-dark rounded-lg shadow-md p-6 text-center">
          <p class="text-2xl font-bold text-primary-light dark:text-primary-dark"><%= totalOrders %></p>
          <p class="text-gray-600 dark:text-gray-400">Total Orders</p>
        </div>
        <div class="bg-white dark:bg-secondary-dark rounded-lg shadow-md p-6 text-center">
          <p class="text-2xl font-bold text-primary-light dark:text-primary-dark">
            <%= (totalAmount).toFixed(2) %> L.E
          </p>
          <p class="text-gray-600 dark:text-gray-400">Total Spend</p>
        </div>
        <div class="bg-white dark:bg-secondary-dark rounded-lg shadow-md p-6 text-center">
          <p class="text-2xl font-bold text-primary-light dark:text-primary-dark"><%= productsLength %></p>
          <p class="text-gray-600 dark:text-gray-400">Purchased Products</p>
        </div>
      </div>

      <div class="bg-white dark:bg-secondary-dark rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold mb-4 text-primary-light dark:text-primary-dark">Order History</h2>
        <div class="space-y-6">
          <% orders.forEach(order => { %> <% order.products.forEach((product) => { %>
          <a href="/view-order/<%= order.id %>" class="block">
            <div
              class="flex flex-col sm:flex-row justify-between items-start sm:items-center p-4 bg-gray-100 dark:bg-gray-800 rounded-lg">
              <div class="flex items-center space-x-4 mb-4 sm:mb-0">
                <img src="<%= product.img %>" alt="<%= product.name %>" class="w-16 h-16 object-cover rounded-md" />
                <div>
                  <h3 class="font-semibold"><%= product.name %></h3>
                  <p class="text-sm text-gray-600 dark:text-gray-400">
                    Purchased on <%= new Date(order.createdAt.toDate()).toLocaleString('en-US', { month: 'short', day:
                    'numeric', year: 'numeric' }) %>
                  </p>
                </div>
              </div>
              <div class="flex flex-col items-end">
                <span
                  class="px-2 py-1 rounded-full text-xs font-semibold <%= order.status[order.status.length - 1].state === 'Delivered' ? 'bg-green-200 text-green-800' : order.status[order.status.length - 1].state === 'Shipping' ? 'bg-blue-200 text-blue-800' : order.status[order.status.length - 1].state === 'Processing' ? 'bg-yellow-200 text-yellow-800' : 'bg-red-200 text-red-800' %>">
                  <%= order.status[order.status.length - 1].state %>
                </span>
                <p class="mt-2 font-semibold text-primary-light dark:text-primary-dark">
                  <%= (product.price * product.quantity).toFixed(2) %> L.E
                </p>
              </div>
            </div>
          </a>
          <% }); %> <% }); %>
        </div>
      </div>
    </main>

    <%- include("./partials/footer") %>

    <!-- <script>
      document.getElementById("logout").addEventListener("click", () => {
        location.replace("/logout");
      });
    </script> -->
    <script src="/js/cart.js"></script>
  </body>
</html>
